// Test: {{test_spec_id}} - {{test_spec_title}}
// Story: {{story_id}} - {{story_title}}
// Generated by /sdlc-studio test-automation
//
// Framework: xUnit
// Coverage: Unit and Integration tests for C#/.NET
//
// Usage:
//   dotnet test --filter "FullyQualifiedName~{{test_class_name}}"
//
using System;
using System.Threading.Tasks;
using Xunit;
using Moq;
using FluentAssertions;
{{#each imports}}
using {{namespace}};
{{/each}}

namespace {{test_namespace}}
{
    /// <summary>
    /// {{test_spec_title}}
    /// Test Spec: {{test_spec_id}}
    /// </summary>
    public class {{test_class_name}} : IClassFixture<{{fixture_class}}>
    {
        private readonly {{fixture_class}} _fixture;
        {{#each mocks}}
        private readonly Mock<{{interface_type}}> _{{mock_name}};
        {{/each}}
        private readonly {{service_under_test}} _sut;

        public {{test_class_name}}({{fixture_class}} fixture)
        {
            _fixture = fixture;
            {{#each mocks}}
            _{{mock_name}} = new Mock<{{interface_type}}>();
            {{/each}}
            _sut = new {{service_under_test}}(
                {{#each constructor_params}}
                {{#if is_mock}}_{{param_name}}.Object{{else}}{{param_value}}{{/if}}{{#unless @last}},{{/unless}}
                {{/each}}
            );
        }

        #region {{test_group_name}}

        {{#each test_cases}}
        /// <summary>
        /// {{test_case_id}}: {{test_case_title}}
        /// Priority: {{priority}}
        /// </summary>
        [Fact]
        [Trait("Category", "{{test_type}}")]
        [Trait("Story", "{{story_id}}")]
        public async Task {{test_method_name}}()
        {
            // Arrange
            // Given: {{given_description}}
            {{#each arrange_steps}}
            {{code}}
            {{/each}}

            {{#each mock_setups}}
            _{{mock_name}}
                .Setup(x => x.{{method_call}})
                .ReturnsAsync({{return_value}});
            {{/each}}

            // Act
            // When: {{when_description}}
            {{act_code}}

            // Assert
            // Then: {{then_description}}
            {{#each assertions}}
            {{assertion_code}}
            {{/each}}

            {{#each mock_verifications}}
            _{{mock_name}}.Verify(x => x.{{method_call}}, Times.{{times}});
            {{/each}}
        }

        {{/each}}
        #endregion

        #region Edge Cases

        {{#each edge_case_tests}}
        /// <summary>
        /// {{test_case_id}}: {{scenario}}
        /// Edge case from story {{story_id}}
        /// </summary>
        [Fact]
        [Trait("Category", "EdgeCase")]
        public async Task {{test_method_name}}()
        {
            // Arrange
            {{arrange_code}}

            // Act
            {{act_code}}

            // Assert
            {{assert_code}}
        }

        {{/each}}
        #endregion

        #region Error Scenarios

        {{#each error_tests}}
        /// <summary>
        /// {{test_case_id}}: {{scenario}}
        /// Expected: {{expected_exception}}
        /// </summary>
        [Fact]
        [Trait("Category", "Error")]
        public async Task {{test_method_name}}()
        {
            // Arrange
            {{arrange_code}}

            // Act & Assert
            await Assert.ThrowsAsync<{{expected_exception}}>(async () =>
            {
                {{act_code}}
            });
        }

        {{/each}}
        #endregion
    }

    #region Test Fixtures

    /// <summary>
    /// Shared test fixture for {{test_class_name}}
    /// </summary>
    public class {{fixture_class}} : IAsyncLifetime
    {
        {{#each fixture_properties}}
        public {{property_type}} {{property_name}} { get; private set; }
        {{/each}}

        public async Task InitializeAsync()
        {
            {{#each fixture_setup}}
            {{code}}
            {{/each}}
        }

        public async Task DisposeAsync()
        {
            {{#each fixture_teardown}}
            {{code}}
            {{/each}}
        }
    }

    #endregion

    #region Test Data

    /// <summary>
    /// Test data builders for {{test_class_name}}
    /// </summary>
    public static class {{test_class_name}}TestData
    {
        {{#each test_data_builders}}
        public static {{return_type}} {{builder_name}}(
            {{#each parameters}}
            {{param_type}} {{param_name}} = {{default_value}}{{#unless @last}},{{/unless}}
            {{/each}}
        )
        {
            return new {{return_type}}
            {
                {{#each properties}}
                {{property_name}} = {{property_value}},
                {{/each}}
            };
        }

        {{/each}}
    }

    #endregion
}
