/*
 * Test: {{test_spec_id}} - {{test_spec_title}}
 * Story: {{story_id}} - {{story_title}}
 * Generated by /sdlc-studio test-automation
 *
 * Framework: JUnit 5 with Mockito
 * Coverage: Unit and Integration tests for Java
 *
 * Usage:
 *   mvn test -Dtest={{test_class_name}}
 *   gradle test --tests {{test_class_name}}
 */
package {{test_package}};

import org.junit.jupiter.api.*;
import org.junit.jupiter.api.extension.ExtendWith;
import org.junit.jupiter.params.ParameterizedTest;
import org.junit.jupiter.params.provider.*;
import org.mockito.*;
import org.mockito.junit.jupiter.MockitoExtension;
{{#each imports}}
import {{import_path}};
{{/each}}

import static org.assertj.core.api.Assertions.*;
import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.*;

/**
 * {{test_spec_title}}
 * <p>
 * Test Spec: {{test_spec_id}}
 * Story: {{story_id}}
 */
@ExtendWith(MockitoExtension.class)
@DisplayName("{{test_display_name}}")
class {{test_class_name}} {

    {{#each mocks}}
    @Mock
    private {{interface_type}} {{mock_name}};
    {{/each}}

    @InjectMocks
    private {{service_under_test}} sut;

    {{#each test_fixtures}}
    private {{fixture_type}} {{fixture_name}};
    {{/each}}

    @BeforeEach
    void setUp() {
        {{#each setup_steps}}
        {{code}}
        {{/each}}
    }

    @AfterEach
    void tearDown() {
        {{#each teardown_steps}}
        {{code}}
        {{/each}}
    }

    // =========================================================================
    // {{test_group_name}}
    // =========================================================================

    @Nested
    @DisplayName("{{nested_display_name}}")
    class {{nested_class_name}} {

        {{#each test_cases}}
        /**
         * {{test_case_id}}: {{test_case_title}}
         * <p>
         * Priority: {{priority}}
         */
        @Test
        @DisplayName("{{display_name}}")
        @Tag("{{test_type}}")
        void {{test_method_name}}() {
            // Given: {{given_description}}
            {{#each arrange_steps}}
            {{code}}
            {{/each}}

            {{#each mock_setups}}
            when({{mock_name}}.{{method_call}}).thenReturn({{return_value}});
            {{/each}}

            // When: {{when_description}}
            {{act_code}}

            // Then: {{then_description}}
            {{#each assertions}}
            {{assertion_code}}
            {{/each}}

            {{#each mock_verifications}}
            verify({{mock_name}}, {{times}}).{{method_call}};
            {{/each}}
        }

        {{/each}}
    }

    // =========================================================================
    // Edge Cases
    // =========================================================================

    @Nested
    @DisplayName("Edge Cases")
    @Tag("EdgeCase")
    class EdgeCases {

        {{#each edge_case_tests}}
        /**
         * {{test_case_id}}: {{scenario}}
         * <p>
         * Edge case from story {{story_id}}
         */
        @Test
        @DisplayName("{{display_name}}")
        void {{test_method_name}}() {
            // Arrange
            {{arrange_code}}

            // Act
            {{act_code}}

            // Assert
            {{assert_code}}
        }

        {{/each}}
    }

    // =========================================================================
    // Error Scenarios
    // =========================================================================

    @Nested
    @DisplayName("Error Scenarios")
    @Tag("Error")
    class ErrorScenarios {

        {{#each error_tests}}
        /**
         * {{test_case_id}}: {{scenario}}
         * <p>
         * Expected: {{expected_exception}}
         */
        @Test
        @DisplayName("{{display_name}}")
        void {{test_method_name}}() {
            // Arrange
            {{arrange_code}}

            // Act & Assert
            assertThatThrownBy(() -> {
                {{act_code}}
            })
                .isInstanceOf({{expected_exception}}.class)
                {{#if expected_message}}
                .hasMessageContaining("{{expected_message}}")
                {{/if}};
        }

        {{/each}}
    }

    // =========================================================================
    // Parameterised Tests
    // =========================================================================

    {{#each parameterised_tests}}
    /**
     * {{test_case_id}}: {{test_case_title}}
     * <p>
     * Parameterised test for multiple input scenarios
     */
    @ParameterizedTest(name = "{{parameter_display}}")
    @{{parameter_source}}({
        {{#each parameter_values}}
        "{{value}}"{{#unless @last}},{{/unless}}
        {{/each}}
    })
    @DisplayName("{{display_name}}")
    void {{test_method_name}}({{#each parameters}}{{param_type}} {{param_name}}{{#unless @last}}, {{/unless}}{{/each}}) {
        // Arrange
        {{arrange_code}}

        // Act
        {{act_code}}

        // Assert
        {{assert_code}}
    }

    {{/each}}

    // =========================================================================
    // Test Data Builders
    // =========================================================================

    {{#each test_data_builders}}
    private static {{return_type}} {{builder_name}}() {
        return {{return_type}}.builder()
            {{#each builder_calls}}
            .{{method_name}}({{value}})
            {{/each}}
            .build();
    }

    private static {{return_type}} {{builder_name}}(
            {{#each parameters}}
            {{param_type}} {{param_name}}{{#unless @last}},{{/unless}}
            {{/each}}) {
        return {{return_type}}.builder()
            {{#each builder_with_params}}
            .{{method_name}}({{value}})
            {{/each}}
            .build();
    }

    {{/each}}
}
