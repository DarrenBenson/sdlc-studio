# Test Environment Docker Compose
#
# Generated by /sdlc-studio test-env setup
# Based on TRD Technology Stack section
#
# Usage:
#   docker compose -f docker-compose.test.yml up -d --wait
#   docker compose -f docker-compose.test.yml run test-runner
#   docker compose -f docker-compose.test.yml down -v
#
version: '3.8'

services:
  # =============================================================================
  # Database Service
  # =============================================================================
  db:
    image: {{db_image}}
    environment:
      {{#if db_postgres}}
      POSTGRES_DB: {{db_name}}
      POSTGRES_USER: {{db_user}}
      POSTGRES_PASSWORD: {{db_password}}
      {{/if}}
      {{#if db_mysql}}
      MYSQL_DATABASE: {{db_name}}
      MYSQL_USER: {{db_user}}
      MYSQL_PASSWORD: {{db_password}}
      MYSQL_ROOT_PASSWORD: {{db_root_password}}
      {{/if}}
    healthcheck:
      {{#if db_postgres}}
      test: ["CMD-SHELL", "pg_isready -U {{db_user}} -d {{db_name}}"]
      {{/if}}
      {{#if db_mysql}}
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      {{/if}}
      interval: 5s
      timeout: 3s
      retries: 5
    ports:
      - "{{db_test_port}}:{{db_port}}"
    volumes:
      - db_data:/var/lib/{{db_data_dir}}

  {{#if redis_enabled}}
  # =============================================================================
  # Cache Service
  # =============================================================================
  redis:
    image: redis:7-alpine
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    ports:
      - "{{redis_test_port}}:6379"
  {{/if}}

  {{#if rabbitmq_enabled}}
  # =============================================================================
  # Message Queue Service
  # =============================================================================
  rabbitmq:
    image: rabbitmq:3-management-alpine
    environment:
      RABBITMQ_DEFAULT_USER: {{rabbitmq_user}}
      RABBITMQ_DEFAULT_PASS: {{rabbitmq_password}}
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    ports:
      - "{{rabbitmq_test_port}}:5672"
      - "{{rabbitmq_mgmt_port}}:15672"
  {{/if}}

  {{#if elasticsearch_enabled}}
  # =============================================================================
  # Search Service
  # =============================================================================
  elasticsearch:
    image: elasticsearch:8
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:9200/_cluster/health | grep -q '\"status\":\"green\"\\|\"status\":\"yellow\"'"]
      interval: 10s
      timeout: 5s
      retries: 10
    ports:
      - "{{es_test_port}}:9200"
  {{/if}}

  # =============================================================================
  # Application Under Test
  # =============================================================================
  app:
    build:
      context: .
      target: {{app_build_target}}
    depends_on:
      db:
        condition: service_healthy
      {{#if redis_enabled}}
      redis:
        condition: service_healthy
      {{/if}}
      {{#if rabbitmq_enabled}}
      rabbitmq:
        condition: service_healthy
      {{/if}}
    environment:
      {{#if db_postgres}}
      DATABASE_URL: postgresql://{{db_user}}:{{db_password}}@db:{{db_port}}/{{db_name}}
      {{/if}}
      {{#if db_mysql}}
      DATABASE_URL: mysql://{{db_user}}:{{db_password}}@db:{{db_port}}/{{db_name}}
      {{/if}}
      {{#if redis_enabled}}
      REDIS_URL: redis://redis:6379
      {{/if}}
      {{#if rabbitmq_enabled}}
      RABBITMQ_URL: amqp://{{rabbitmq_user}}:{{rabbitmq_password}}@rabbitmq:5672
      {{/if}}
      {{#each app_env}}
      {{key}}: {{value}}
      {{/each}}
    ports:
      - "{{app_test_port}}:{{app_port}}"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:{{app_port}}/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # =============================================================================
  # Test Runner
  # =============================================================================
  test-runner:
    build:
      context: .
      target: {{test_build_target}}
    depends_on:
      app:
        condition: service_healthy
    environment:
      APP_URL: http://app:{{app_port}}
      {{#if db_postgres}}
      DATABASE_URL: postgresql://{{db_user}}:{{db_password}}@db:{{db_port}}/{{db_name}}
      {{/if}}
      {{#if db_mysql}}
      DATABASE_URL: mysql://{{db_user}}:{{db_password}}@db:{{db_port}}/{{db_name}}
      {{/if}}
      {{#if redis_enabled}}
      REDIS_URL: redis://redis:6379
      {{/if}}
    command: {{test_command}}
    volumes:
      - ./tests:/app/tests:ro
      - test_results:/app/test-results

volumes:
  db_data:
  test_results:

# =============================================================================
# Networks (optional - uncomment if needed)
# =============================================================================
# networks:
#   test-network:
#     driver: bridge
